#!/bin/bash -e

if [ ! -d "/data/plugins" ]; then
    cp -rp /opt/roundcube/plugins /data/plugins
    rm -fr /opt/roundcube/plugins
fi

if [ ! -L "/opt/roundcube/plugins" ]; then
    rm -fr /opt/roundcube/plugins
    ln -s /data/plugins /opt/roundcube/plugins
fi

if [ ! -d "/data/config" ]; then
    mkdir -p /data/config
fi

if [ ! -d "/data/logs" ]; then
    mkdir -p /data/logs
fi

if [ ! -f "/data/config/config.inc.php" ]; then
    cat > /data/config/config.inc.php <<'EOF'
<?php
$config['enable_installer'] = false;
EOF
fi

if [ ! -e "/data/config/php-user.ini" ]; then
    cat > /data/config/php-user.ini <<'EOF'
date.timezone = 'Europe/Amsterdam'
EOF
fi

if [[ -e "/data/config/php-user.ini" ]] && [[ ! -e "/etc/php5/fpm/conf.d/999-user.ini" ]]
then
    ln -s /data/config/php-user.ini /etc/php5/fpm/conf.d/999-user.ini
fi

if ! service php5-fpm status > /dev/null 2>&1; then
    service php5-fpm start
fi

exec /usr/sbin/nginx
